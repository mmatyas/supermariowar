branches:
  only:
    - master

platform:
  - x86
  - x64

environment:
  matrix:
    - USE_SDL2: true
    - USE_SDL2: false

matrix:
  allow_failures:
    - platform: x64

cache:
  - x86_64-4.9.2-release-win32-seh-rt_v4-rev4.7z
  - zlib-1.2.8-1-mingw32-dev.tar.lzma
  - SDL-devel-1.2.15-mingw32.tar.gz
  - SDL_image-devel-1.2.12-VC.zip
  - SDL_mixer-devel-1.2.12-VC.zip
  - SDL2-devel-2.0.4-mingw.tar.gz
  - SDL2_image-devel-2.0.1-mingw.tar.gz
  - SDL2_mixer-devel-2.0.1-mingw.tar.gz

install:
  - git submodule update --init --recursive

  # Get MinGW 4.9
  - echo Installing MinGW 4.9.2
  - set MINGW_FILENAME=x86_64-4.9.2-release-win32-seh-rt_v4-rev4.7z
  - set MINGW_URL=http://sourceforge.net/projects/mingw-w64/files/Toolchains%20targetting%20Win64/Personal%20Builds/mingw-builds/4.9.2/threads-win32/seh/x86_64-4.9.2-release-win32-seh-rt_v4-rev4.7z/download
  - if not exist "%MINGW_FILENAME%" appveyor DownloadFile "%MINGW_URL%" -FileName "%MINGW_FILENAME%"
  - 7z x $filename > nul
  - ps: Get-Command sh.exe -All | Remove-Item

  - echo Installing dependencies
  # Set up Zlib
  - if not exist zlib-1.2.8-1-mingw32-dev.tar.lzma appveyor DownloadFile http://sourceforge.net/projects/mingw/files/MinGW/Base/zlib/zlib-1.2.8/zlib-1.2.8-1-mingw32-dev.tar.lzma
  - 7z x zlib-1.2.8-1-mingw32-dev.tar.lzma
  - 7z x -ozlib zlib-1.2.8-1-mingw32-dev.tar
  # Set up SDL 1.2 libs
  - |
    if [%USE_SDL2%]==[false] (
      echo Setting up SDL 1.2.x
      if not exist SDL-devel-1.2.15-mingw32.tar.gz appveyor DownloadFile https://www.libsdl.org/release/SDL-devel-1.2.15-mingw32.tar.gz
      if not exist SDL_image-devel-1.2.12-VC.zip appveyor DownloadFile https://www.libsdl.org/projects/SDL_image/release/SDL_image-devel-1.2.12-VC.zip
      if not exist SDL_mixer-devel-1.2.12-VC.zip appveyor DownloadFile https://www.libsdl.org/projects/SDL_mixer/release/SDL_mixer-devel-1.2.12-VC.zip
      7z x SDL-devel-1.2.15-mingw32.tar.gz
      7z x -xr!._\* -xr!man -xr!docs SDL-devel-1.2.15-mingw32.tar
      7z x SDL_image-devel-1.2.12-VC.zip
      7z x SDL_mixer-devel-1.2.12-VC.zip
      xcopy /S/Y SDL_image-1.2.12 SDL-1.2.15
      xcopy /S/Y SDL_mixer-1.2.12 SDL-1.2.15
      set SDLDIR=%CD%\SDL-1.2.15
      echo SDLDIR set to %SDLDIR%
    )
  # Set up SDL2 libs
  - |
    if [%USE_SDL2%]==[true] (
      echo Setting up SDL2
      if not exist SDL2-devel-2.0.4-mingw.tar.gz appveyor DownloadFile https://www.libsdl.org/release/SDL2-devel-2.0.4-mingw.tar.gz
      if not exist SDL2_image-devel-2.0.1-mingw.tar.gz appveyor DownloadFile https://www.libsdl.org/projects/SDL_image/release/SDL2_image-devel-2.0.1-mingw.tar.gz
      if not exist SDL2_mixer-devel-2.0.1-mingw.tar.gz appveyor DownloadFile https://www.libsdl.org/projects/SDL_mixer/release/SDL2_mixer-devel-2.0.1-mingw.tar.gz
      7z x SDL2-devel-2.0.4-mingw.tar.gz
      7z x -xr!._\* -xr!man -xr!docs SDL2-devel-2.0.4-mingw.tar
      7z x SDL2_image-devel-2.0.1-mingw.tar.gz
      7z x -xr!._\* -xr!man -xr!docs SDL2_image-devel-2.0.1-mingw.tar
      7z x SDL2_mixer-devel-2.0.1-mingw.tar.gz
      7z x -xr!._\* -xr!man -xr!docs SDL2_mixer-devel-2.0.1-mingw.tar
      xcopy /S/Y SDL2_image-2.0.1 SDL2-2.0.4
      xcopy /S/Y SDL2_mixer-2.0.1 SDL2-2.0.4
      if [%PLATFORM%]==[x86] ( set SDL2DIR=%CD%\SDL2-2.0.4\i686-w64-mingw32 )
      else                   ( set SDL2DIR=%CD%\SDL2-2.0.4\x86_64-w64-mingw32 )
      echo SDL2DIR set to %SDL2DIR%
    )

before_build:
  - set Path=%CD%\mingw64\bin;%Path%
  - g++ --version
  - mingw32-make --version
  - cmake --version

build_script:
  - |
    if [%USE_SDL2%]==[false] (
      cmake -H. -Bbuild -G 'MinGW Makefiles' -DZLIB_ROOT=%CD%\zlib
      cmake --build build
    )
  - |
    if [%USE_SDL2%]==[true] (
      cmake -H. -Bbuild -G 'MinGW Makefiles' -DZLIB_ROOT=%CD%\zlib -DUSE_SDL2_LIBS=1
      cd build
      make smw
    )

artifacts:
  - path: build\Binaries\Release\*.exe
